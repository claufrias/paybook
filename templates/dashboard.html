<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedCajeros - Dashboard</title>
    
    <!-- Bootstrap 5 Dark -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-night.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Nuestro CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="story-circle mb-4 pulse" style="width: 80px; height: 80px; border: none;">
                <i class="fas fa-money-bill-wave fa-2x"></i>
            </div>
            <h4 class="gradient-text mb-3">Cargando...</h4>
            <p class="text-muted">Por favor espere</p>
            <div class="progress mt-3" style="height: 4px; width: 200px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--dark-border);">
        <div class="container-fluid">
            <!-- Logo -->
            <a class="navbar-brand" href="/dashboard">
                <div class="d-flex align-items-center">
                    <div class="story-circle small me-3">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <h4 class="gradient-text mb-0">RedCajeros</h4>
                        <small class="text-muted">Dashboard</small>
                    </div>
                </div>
            </a>
            
            <!-- User Menu -->
            <div id="userNav">
                <!-- Se llena con JavaScript -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Alert Container -->
        <div id="alertContainer" class="mb-3"></div>
        
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="user-welcome">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h1 class="gradient-text mb-2" id="dashboardTitle">Bienvenido</h1>
                    <p class="text-muted mb-0">Gesti√≥n profesional de tus cajeros y comisiones</p>
                </div>
            </div>
        </div>
        
        <!-- Subscription Status -->
        <div class="subscription-status">
            <div id="subscriptionInfo">
                <!-- Se llena con JavaScript -->
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="dashboard-stats">
            <div class="stat-card-user">
                <div class="stat-label-user">Cajeros Activos</div>
                <div class="stat-number-user" id="statsCajeros">0</div>
                <small class="text-muted"><i class="fas fa-user me-1"></i> En tu cuenta</small>
            </div>
            
            <div class="stat-card-user">
                <div class="stat-label-user">Cargas Totales</div>
                <div class="stat-number-user" id="statsCargas">0</div>
                <small class="text-muted"><i class="fas fa-list me-1"></i> Este mes</small>
            </div>
            
            <div class="stat-card-user">
                <div class="stat-label-user">Total Pendiente</div>
                <div class="stat-number-user" id="statsPendiente">$0</div>
                <small class="text-muted"><i class="fas fa-money-bill-wave me-1"></i> Por cobrar</small>
            </div>
            
            <div class="stat-card-user">
                <div class="stat-label-user">D√≠as Restantes</div>
                <div class="stat-number-user" id="statsDias">0</div>
                <small class="text-muted"><i class="fas fa-calendar me-1"></i> De tu plan</small>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions mb-4">
            <div class="quick-action-btn" onclick="window.location.href='#'">
                <i class="fas fa-plus-circle"></i>
                <div>Nuevo Cajero</div>
            </div>
            <div class="quick-action-btn" onclick="mostrarModalPago()">
                <i class="fas fa-credit-card"></i>
                <div>Renovar Plan</div>
            </div>
            <div class="quick-action-btn" onclick="exportarReporte()">
                <i class="fas fa-file-pdf"></i>
                <div>Exportar PDF</div>
            </div>
            <div class="quick-action-btn" onclick="verPendientes()">
                <i class="fas fa-clock"></i>
                <div>Ver Pendientes</div>
            </div>
        </div>
        
        <!-- Main Dashboard Content (from original index.html) -->
        <div class="row">
            <!-- Left Column - Forms -->
            <div class="col-lg-4">
                <!-- Cajero Form -->
                <div class="ig-card mb-4 fade-in" id="formCajero">
                    <div class="ig-card-header d-flex align-items-center">
                        <div class="story-circle small me-3">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 gradient-text">Nuevo Cajero</h5>
                            <small class="text-muted">Agregar cajero al sistema</small>
                        </div>
                    </div>
                    <div class="ig-card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted">Nombre del Cajero</label>
                            <input type="text" id="nombreCajero" class="form-control form-control-ig" 
                                   placeholder="Ej: Juan P√©rez" autocomplete="off">
                        </div>
                        <button class="btn btn-ig w-100 hover-lift" onclick="agregarCajero()">
                            <i class="fas fa-user-check me-2"></i> Agregar Cajero
                        </button>
                        <div class="mt-2 text-center">
                            <small class="text-muted" id="cajerosCount">
                                <i class="fas fa-users me-1"></i> 0 cajeros activos
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Carga Form -->
                <div class="ig-card mb-4 fade-in" id="formCarga">
                    <div class="ig-card-header d-flex align-items-center">
                        <div class="story-circle small me-3">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 gradient-text">Nueva Carga</h5>
                            <small class="text-muted">Registrar comisi√≥n</small>
                        </div>
                    </div>
                    <div class="ig-card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted">Cajero</label>
                            <select id="selectCajero" class="form-select form-select-ig">
                                <option value="">Cargando cajeros...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Plataforma</label>
                            <select id="selectPlataforma" class="form-select form-select-ig">
                                <option value="Zeus">üî± Zeus</option>
                                <option value="Gana">üéØ Gana</option>
                                <option value="Ganamos">üí∞ Ganamos</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Monto ($)</label>
                            <input type="number" id="montoCarga" class="form-control form-control-ig" 
                                   step="0.01" min="0.01" placeholder="0.00" autocomplete="off">
                        </div>
                        <button class="btn btn-ig w-100 hover-lift" onclick="agregarCarga()">
                            <i class="fas fa-save me-2"></i> Guardar Carga
                        </button>
                        <div class="mt-2 text-center">
                            <small class="text-muted" id="cargasCount">
                                <i class="fas fa-list me-1"></i> 0 cargas registradas
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="ig-card fade-in" id="formFiltros">
                    <div class="ig-card-header d-flex align-items-center">
                        <div class="story-circle small me-3">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 gradient-text">Filtros</h5>
                            <small class="text-muted">Buscar por fecha</small>
                        </div>
                    </div>
                    <div class="ig-card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted">Desde</label>
                            <input type="datetime-local" id="fechaInicio" class="form-control form-control-ig">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">Hasta</label>
                            <input type="datetime-local" id="fechaFin" class="form-control form-control-ig">
                        </div>
                        <div class="row g-2">
                            <div class="col">
                                <button class="btn btn-ig-outline w-100 hover-lift" onclick="filtrarCargas()">
                                    <i class="fas fa-search me-2"></i> Buscar
                                </button>
                            </div>
                            <div class="col">
                                <button class="btn btn-outline-secondary w-100 hover-lift" onclick="limpiarFiltro()">
                                    <i class="fas fa-broom me-2"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Data -->
            <div class="col-lg-8">
                <!-- Summary Cards -->
                <div class="row mb-4" id="seccionResumen">
                    <div class="col-md-6 mb-3">
                        <div class="stat-card hover-lift">
                            <div class="stat-label">TOTAL HOY</div>
                            <div class="stat-number" id="totalHoy">$0</div>
                            <div class="text-success small mt-2" id="totalHoyNombre">
                                <i class="fas fa-calendar-day me-1"></i> Hoy
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="stat-card hover-lift">
                            <div class="stat-label">TOP CAJERO</div>
                            <div class="stat-number" id="topCajero">$0</div>
                            <div class="text-info small mt-2" id="topCajeroNombre">
                                <i class="fas fa-user me-1"></i> Sin datos
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Table -->
                <div class="ig-card mb-4 fade-in" id="seccionTablaResumen">
                    <div class="ig-card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 gradient-text">Resumen por Cajero</h5>
                            <small class="text-muted">Total acumulado por plataforma</small>
                        </div>
                        <div>
                            <span class="badge-ig me-2" id="contadorCajeros">0 cajeros</span>
                        </div>
                    </div>
                    <div class="ig-card-body">
                        <div class="table-responsive">
                            <table class="table table-ig table-hover">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-user me-2"></i>Cajero</th>
                                        <th class="text-end">üî± Zeus</th>
                                        <th class="text-end">üéØ Gana</th>
                                        <th class="text-end">üí∞ Ganamos</th>
                                        <th class="text-end">üèÜ Total</th>
                                        <th class="text-center"><i class="fas fa-money-bill-wave me-2"></i>Pagar</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaResumen">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-5">
                                            <div class="mb-3">
                                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                            </div>
                                            <h6>Cargando resumen...</h6>
                                            <small class="text-muted">Por favor espere</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="ig-card fade-in" id="seccionHistorial">
                    <div class="ig-card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 gradient-text">Historial Reciente</h5>
                            <small class="text-muted">√öltimas cargas registradas</small>
                        </div>
                        <div>
                            <small class="text-muted me-2" id="historialCount">
                                <i class="fas fa-list me-1"></i> 0 cargas
                            </small>
                        </div>
                    </div>
                    <div class="ig-card-body">
                        <div class="table-responsive">
                            <table class="table table-ig table-hover">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-calendar me-2"></i>Fecha/Hora</th>
                                        <th><i class="fas fa-user me-2"></i>Cajero</th>
                                        <th><i class="fas fa-gamepad me-2"></i>Plataforma</th>
                                        <th class="text-end"><i class="fas fa-money-bill me-2"></i>Monto</th>
                                        <th class="text-center"><i class="fas fa-cog me-2"></i>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCargas">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-5">
                                            <div class="mb-3">
                                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                            </div>
                                            <h6>Cargando datos...</h6>
                                            <small class="text-muted">Por favor espere</small>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-center pt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Se muestran las √∫ltimas 50 cargas
                                            </small>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-3 mt-5 border-top border-dark">
        <div class="container text-center">
            <small class="text-muted">
                <i class="fas fa-code me-1"></i> RedCajeros v3.0 | 
                <i class="fas fa-user ms-3 me-1"></i> Sistema Multi-Usuario |
                <i class="fas fa-shield-alt ms-3 me-1"></i> Tus datos est√°n seguros
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Nuestro JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // Actualizar estad√≠sticas del dashboard
        function actualizarEstadisticasDashboard() {
            // Cajeros activos
            const statsCajeros = document.getElementById('statsCajeros');
            if (statsCajeros) {
                const activos = cajeros.filter(c => c.activo).length;
                statsCajeros.textContent = activos;
            }
            
            // Cargas totales
            const statsCargas = document.getElementById('statsCargas');
            if (statsCargas) {
                // Cargas de este mes
                const hoy = new Date();
                const mesActual = hoy.getMonth();
                const cargasEsteMes = cargas.filter(c => {
                    if (!c.fecha) return false;
                    const fechaCarga = new Date(c.fecha);
                    return fechaCarga.getMonth() === mesActual;
                }).length;
                statsCargas.textContent = cargasEsteMes;
            }
            
            // Total pendiente
            const statsPendiente = document.getElementById('statsPendiente');
            if (statsPendiente) {
                const totalPendiente = resumen.reduce((sum, item) => sum + item.total, 0);
                statsPendiente.textContent = `$${totalPendiente.toFixed(2)}`;
            }
            
            // D√≠as restantes
            const statsDias = document.getElementById('statsDias');
            if (statsDias && usuarioActual && usuarioActual.expiracion) {
                const expiracion = new Date(usuarioActual.expiracion);
                const hoy = new Date();
                const diffTime = expiracion - hoy;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                statsDias.textContent = diffDays > 0 ? diffDays : 0;
            }
        }
        
        // Sobreescribir actualizarTodaLaUI para incluir estad√≠sticas del dashboard
        const originalActualizarTodaLaUI = actualizarTodaLaUI;
        actualizarTodaLaUI = function() {
            originalActualizarTodaLaUI();
            actualizarEstadisticasDashboard();
        };
        
        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            if (usuarioActual) {
                cargarDatosIniciales();
            }
        });
    </script>
</body>
</html>