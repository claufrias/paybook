<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayBook - Acceso</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-night.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px 16px;
            background:
                radial-gradient(circle at 10% 10%, rgba(56, 189, 248, 0.28), transparent 45%),
                radial-gradient(circle at 95% 90%, rgba(249, 115, 22, 0.2), transparent 40%),
                linear-gradient(150deg, #04141e 0%, #071a26 45%, #111827 100%);
        }

        .auth-shell {
            width: 100%;
            max-width: 1080px;
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 22px;
        }

        .auth-panel,
        .auth-side {
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: linear-gradient(180deg, rgba(7, 24, 34, 0.95), rgba(3, 14, 22, 0.95));
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        }

        .auth-panel {
            padding: 28px;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 22px;
        }

        .brand-title {
            margin: 0;
            font-size: 2rem;
            font-weight: 800;
            color: #cffafe;
        }

        .brand-subtitle {
            margin-top: 6px;
            color: #a5b4c7;
        }

        .auth-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
            padding: 6px;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(125, 211, 252, 0.24);
        }

        .toggle-btn {
            border: 0;
            border-radius: 10px;
            padding: 10px;
            font-weight: 600;
            color: #cbd5e1;
            background: transparent;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #06b6d4, #22d3ee);
            color: #082f49;
        }

        .ig-card {
            border-radius: 18px;
            border: 1px solid rgba(125, 211, 252, 0.16);
            background: rgba(8, 20, 31, 0.85);
        }

        .ig-card-header {
            border-bottom: 1px solid rgba(125, 211, 252, 0.2);
            background: rgba(15, 33, 49, 0.45);
        }

        .accent-title {
            color: #67e8f9;
        }

        .form-control-ig {
            background: rgba(15, 30, 46, 0.86);
            border: 1px solid rgba(125, 211, 252, 0.2);
            color: #f8fafc;
        }

        .form-control-ig:focus {
            border-color: #22d3ee;
            box-shadow: 0 0 0 0.2rem rgba(34, 211, 238, 0.2);
            background: rgba(17, 34, 50, 0.95);
            color: #fff;
        }

        .btn-auth {
            background: linear-gradient(135deg, #06b6d4, #0ea5e9);
            border: none;
            color: #06263c;
            font-weight: 700;
            border-radius: 12px;
            padding: 11px 14px;
        }

        .btn-register-spotlight {
            width: 100%;
            border-radius: 12px;
            padding: 11px 14px;
            background: linear-gradient(135deg, #f97316, #fb923c);
            border: none;
            color: #fff7ed;
            font-weight: 700;
        }

        .auth-switch { text-align: center; margin-top: 18px; }

        .password-input { position: relative; }

        .password-toggle {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: #94a3b8;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .password-hints {
            margin-top: 8px;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(14, 116, 144, 0.18);
            border: 1px solid rgba(103, 232, 249, 0.24);
        }

        .password-hints li { color: #cbd5e1; font-size: 0.8rem; }
        .password-hints li.ok { color: #86efac; }

        .auth-side {
            padding: 28px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-side h5 {
            color: #fdba74;
            font-weight: 700;
        }

        .side-feature {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            color: #dbeafe;
        }

        .side-feature i { color: #22d3ee; margin-top: 2px; }

        .quick-register {
            margin-top: 16px;
            border-radius: 14px;
            padding: 14px;
            background: rgba(251, 146, 60, 0.12);
            border: 1px solid rgba(251, 146, 60, 0.32);
            color: #ffedd5;
        }

        @media (max-width: 940px) {
            .auth-shell { grid-template-columns: 1fr; max-width: 560px; }
            .auth-panel, .auth-side { padding: 22px; }
        }

        @media (max-width: 540px) {
            .field-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="story-circle mb-4 pulse" style="width: 80px; height: 80px; border: none; background: linear-gradient(135deg, #06b6d4, #f97316);">
                <i class="fa-solid fa-wallet fa-2x"></i>
            </div>
            <h4 class="mb-2" style="color:#67e8f9;">PayBook</h4>
            <p class="text-muted mb-0">Preparando tu acceso...</p>
        </div>
    </div>

    <div class="auth-container">
        <div class="auth-shell">
            <div class="auth-panel">
                <div class="auth-logo">
                    <div class="story-circle mx-auto mb-3" style="width: 78px; height: 78px; background: linear-gradient(135deg, #06b6d4, #f97316);">
                        <i class="fa-solid fa-wallet fa-xl"></i>
                    </div>
                    <h1 class="brand-title">PayBook</h1>
                    <p class="brand-subtitle">Controla cajeros, cargas y comisiones en un solo lugar.</p>
                </div>

                <div class="auth-toggle">
                    <button id="btnLogin" class="toggle-btn active" onclick="mostrarLogin()">Iniciar sesión</button>
                    <button id="btnRegister" class="toggle-btn" onclick="mostrarRegistro()">Crear cuenta</button>
                </div>

                <div id="authAlertContainer" class="mb-3"></div>

                <div class="ig-card mb-4" id="loginForm">
                    <div class="ig-card-header">
                        <h5 class="mb-0 accent-title"><i class="fa-solid fa-right-to-bracket me-2"></i>Bienvenido de nuevo</h5>
                    </div>
                    <div class="ig-card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted" for="loginEmail">Correo electrónico</label>
                            <input type="email" id="loginEmail" class="form-control form-control-ig" placeholder="tu@email.com" autocomplete="off">
                        </div>
                        <div class="mb-3 password-input">
                            <label class="form-label text-muted" for="loginPassword">Contraseña</label>
                            <input type="password" id="loginPassword" class="form-control form-control-ig" placeholder="••••••••">
                            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')"><i class="fa-solid fa-eye"></i></button>
                        </div>
                        <button class="btn btn-auth w-100 mb-3" onclick="login()"><i class="fa-solid fa-arrow-right-to-bracket me-2"></i>Entrar</button>
                        <button class="btn-register-spotlight" onclick="mostrarRegistro()"><i class="fa-solid fa-user-plus me-2"></i>¿Eres nuevo? Crea tu cuenta gratis</button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="mostrarRecuperar()" class="text-info">¿Olvidaste tu contraseña?</a>
                        </div>
                    </div>
                </div>

                <div class="ig-card mb-4 d-none" id="registerForm">
                    <div class="ig-card-header">
                        <h5 class="mb-0 accent-title"><i class="fa-solid fa-user-plus me-2"></i>Registro de nuevo usuario</h5>
                    </div>
                    <div class="ig-card-body">
                        <div class="mb-3 field-row">
                            <div>
                                <label class="form-label text-muted" for="registerNombre">Nombre</label>
                                <input type="text" id="registerNombre" class="form-control form-control-ig" placeholder="Juan" autocomplete="off">
                            </div>
                            <div>
                                <label class="form-label text-muted" for="registerApellido">Apellido</label>
                                <input type="text" id="registerApellido" class="form-control form-control-ig" placeholder="Pérez" autocomplete="off">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted" for="registerEmail">Correo electrónico</label>
                            <input type="email" id="registerEmail" class="form-control form-control-ig" placeholder="tu@email.com" autocomplete="off">
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted" for="registerTelefono">Teléfono (WhatsApp)</label>
                            <input type="text" id="registerTelefono" class="form-control form-control-ig" placeholder="0412-1234567" autocomplete="off">
                        </div>

                        <div class="mb-3 password-input">
                            <label class="form-label text-muted" for="registerPassword">Contraseña</label>
                            <input type="password" id="registerPassword" class="form-control form-control-ig" placeholder="Mínimo 10 caracteres">
                            <button type="button" class="password-toggle" onclick="togglePassword('registerPassword')"><i class="fa-solid fa-eye"></i></button>
                            <div class="password-hints">
                                <ul class="mb-0">
                                    <li id="hintLength">Mínimo 10 caracteres</li>
                                    <li id="hintUpper">Al menos una mayúscula (A-Z)</li>
                                    <li id="hintLower">Al menos una minúscula (a-z)</li>
                                    <li id="hintNumber">Al menos un número (0-9)</li>
                                    <li id="hintSymbol">Al menos un símbolo (!@#$...)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-3 password-input">
                            <label class="form-label text-muted" for="registerConfirm">Confirmar contraseña</label>
                            <input type="password" id="registerConfirm" class="form-control form-control-ig" placeholder="••••••••">
                            <button type="button" class="password-toggle" onclick="togglePassword('registerConfirm')"><i class="fa-solid fa-eye"></i></button>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="registerTerms">
                            <label class="form-check-label text-muted small" for="registerTerms">
                                Acepto los <a href="#" class="text-info">Términos de Servicio</a> y <a href="#" class="text-info">Política de Privacidad</a>
                            </label>
                        </div>

                        <button class="btn btn-auth w-100" onclick="register()"><i class="fa-solid fa-user-check me-2"></i>Crear cuenta gratis</button>
                    </div>
                </div>

                <div class="ig-card mb-4 d-none" id="forgotForm">
                    <div class="ig-card-header">
                        <h5 class="mb-0 accent-title"><i class="fa-solid fa-key me-2"></i>Recuperar contraseña</h5>
                    </div>
                    <div class="ig-card-body">
                        <div class="mb-3">
                            <label class="form-label text-muted" for="forgotEmail">Email registrado</label>
                            <input type="email" id="forgotEmail" class="form-control form-control-ig" placeholder="tu@email.com" autocomplete="off">
                        </div>
                        <button class="btn btn-auth w-100 mb-3" onclick="recuperarContrasena()"><i class="fa-solid fa-paper-plane me-2"></i>Enviar instrucciones</button>
                        <div class="text-center"><a href="#" onclick="mostrarLogin()" class="text-info"><i class="fa-solid fa-arrow-left me-1"></i>Volver al login</a></div>
                    </div>
                </div>

                <div class="auth-switch">
                    <div id="loginSwitch" class="d-none"><small class="text-muted">¿No tienes cuenta?</small> <a href="#" onclick="mostrarRegistro()" class="text-info">Regístrate gratis</a></div>
                    <div id="registerSwitch"><small class="text-muted">¿Ya tienes cuenta?</small> <a href="#" onclick="mostrarLogin()" class="text-info">Inicia sesión</a></div>
                </div>
            </div>

            <aside class="auth-side">
                <h5 class="mb-3">Prueba gratuita de 7 días</h5>
                <div class="side-feature"><i class="fa-solid fa-circle-check"></i><span>Alta de cajeros y gestión completa de operaciones.</span></div>
                <div class="side-feature"><i class="fa-solid fa-circle-check"></i><span>Control diario de comisiones y balances.</span></div>
                <div class="side-feature"><i class="fa-solid fa-circle-check"></i><span>Reportes claros para seguimiento y cierre de caja.</span></div>
                <div class="side-feature"><i class="fa-solid fa-circle-check"></i><span>Soporte por WhatsApp para ayudarte a iniciar rápido.</span></div>
                <div class="quick-register">
                    <strong>Nuevo en la plataforma?</strong>
                    <p class="mb-2 mt-2">Empieza creando tu usuario ahora. Solo tomará unos minutos.</p>
                    <button class="btn-register-spotlight" onclick="mostrarRegistro()"><i class="fa-solid fa-sparkles me-2"></i>Ir al registro</button>
                </div>
            </aside>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <script>
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.parentElement.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function setActiveTab(isRegister) {
            document.getElementById('btnLogin').classList.toggle('active', !isRegister);
            document.getElementById('btnRegister').classList.toggle('active', isRegister);
        }

        function mostrarLogin() {
            document.getElementById('loginForm').classList.remove('d-none');
            document.getElementById('registerForm').classList.add('d-none');
            document.getElementById('forgotForm').classList.add('d-none');
            document.getElementById('loginSwitch').classList.add('d-none');
            document.getElementById('registerSwitch').classList.remove('d-none');
            setActiveTab(false);
        }

        function mostrarRegistro() {
            document.getElementById('loginForm').classList.add('d-none');
            document.getElementById('registerForm').classList.remove('d-none');
            document.getElementById('forgotForm').classList.add('d-none');
            document.getElementById('loginSwitch').classList.remove('d-none');
            document.getElementById('registerSwitch').classList.add('d-none');
            setActiveTab(true);
        }

        function mostrarRecuperar() {
            document.getElementById('loginForm').classList.add('d-none');
            document.getElementById('registerForm').classList.add('d-none');
            document.getElementById('forgotForm').classList.remove('d-none');
            document.getElementById('loginSwitch').classList.remove('d-none');
            document.getElementById('registerSwitch').classList.add('d-none');
            setActiveTab(false);
        }

        function updatePasswordHints(password) {
            const checks = [
                { id: 'hintLength', valid: password.length >= 10 },
                { id: 'hintUpper', valid: /[A-Z]/.test(password) },
                { id: 'hintLower', valid: /[a-z]/.test(password) },
                { id: 'hintNumber', valid: /\d/.test(password) },
                { id: 'hintSymbol', valid: /[^A-Za-z0-9]/.test(password) }
            ];
            checks.forEach(({ id, valid }) => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('ok', valid);
            });
        }

        async function checkAuth() {
            try {
                if (sessionStorage.getItem('auth_redirect_from_dashboard') === '1') {
                    sessionStorage.removeItem('auth_redirect_from_dashboard');
                    return;
                }
                const response = await fetch('/api/user/info', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        window.location.href = '/dashboard';
                    }
                }
            } catch (error) {
                // no-op
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            document.getElementById('loginPassword').addEventListener('keypress', function(e) { if (e.key === 'Enter') login(); });
            document.getElementById('registerConfirm').addEventListener('keypress', function(e) { if (e.key === 'Enter') register(); });
            document.getElementById('registerPassword').addEventListener('input', function(e) { updatePasswordHints(e.target.value); });
            document.getElementById('forgotEmail').addEventListener('keypress', function(e) { if (e.key === 'Enter') recuperarContrasena(); });
            setActiveTab(false);
        });
    </script>
</body>
</html>
